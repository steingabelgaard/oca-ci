#!/bin/bash

#
# Install dependencies of addons to test, and add addons to test to Odoo's addons_path.
#
# An alternative technique would be to install all addons with `pip install --editable`
# but it is relatively slow in repos with a large number of addons. This is an area
# where pip and/or setuptools could improve.
#

set -ex

# Compute and install direct dependencies of installable addons in $ADDONS_DIR
# (this includes addons, python external dependencies and odoo itself)
mkdir -p  /opt/odoo/dependencies
clone_sg_dependencies /opt/odoo/dependencies ${ADDONS_DIR}
ls -l /opt/odoo/dependencies
touch test-requirements.txt
echo >> "# Primary depends" >> test-requirements.txt
setuptools-odoo-get-requirements --include-addons --addons-dir ${ADDONS_DIR} >> test-requirements.txt

for d in $(getaddons.py /opt/odoo/dependencies)
do
   echo >> "# ${d} depends" >> test-requirements.txt
   setuptools-odoo-get-requirements --include-addons --addons-dir ${d} >> test-requirements.txt
done

# build own addons file:
for m in $(getaddons.py -m /opt/odoo/dependencies)
do
   echo >> "odoo12-addon-${d}" >> own_addons.txt
done
cat own_addons.txt
cat test-requirements.txt
grep -v -x -F -f own_addons.txt test-requirements.txt > filtered-requirements.txt
# Install addons in current repo in editable mode, so coverage will see them.
cat filtered-requirements.txt
pip install -r filtered-requirements.txt
pip config list
pip list

# Add ADDONS_DIR to addons_path.
echo "addons_path=${ADDONS_PATH},${ADDONS_DIR},$(getaddons.py /opt/odoo/dependencies)" >> ${ODOO_RC}
cat ${ODOO_RC}

deps=$(oca_list_external_dependencies deb)
if [ -n "$deps" ]; then
    apt-get update -qq
    # Install 'deb' external dependencies of all Odoo addons found in path.
    DEBIAN_FRONTEND=noninteractive apt-get install -qq --no-install-recommends ${deps}
fi

